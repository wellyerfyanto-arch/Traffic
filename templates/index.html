<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Traffic Generator - Live View</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container">
        <h1>ğŸš€ Google Traffic Generator - Live View</h1>
        
        <div class="dashboard">
            <div class="stats">
                <div class="stat-card">
                    <h3>Total Proxy</h3>
                    <span id="totalProxies">0</span>
                </div>
                <div class="stat-card">
                    <h3>Proxy Aktif</h3>
                    <span id="workingProxies">0</span>
                </div>
                <div class="stat-card">
                    <h3>Status</h3>
                    <span id="globalStatus">Ready</span>
                </div>
                <div class="stat-card">
                    <h3>Iterasi</h3>
                    <span id="iterationStatus">0/0</span>
                </div>
            </div>
        </div>
        
        <div class="tabs">
            <button class="tab-button active" onclick="openTab('trafficTab')">ğŸ¯ Traffic Generator</button>
            <button class="tab-button" onclick="openTab('proxyTab')">ğŸ”§ Proxy Management</button>
            <button class="tab-button" onclick="openTab('liveViewTab')">ğŸ‘ï¸ Live View</button>
        </div>
        
        <!-- Traffic Generator Tab -->
        <div id="trafficTab" class="tab-content active">
            <div class="form-container">
                <form id="trafficForm">
                    <div class="form-group">
                        <label for="keyword">ğŸ” Kata Kunci Pencarian:</label>
                        <input type="text" id="keyword" name="keyword" 
                               value="teknologi terbaru 2024" required>
                        <small>Kata kunci yang akan dicari di Google</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="website_url">ğŸŒ URL Target Website:</label>
                        <input type="text" id="website_url" name="website_url" 
                               placeholder="example.com" required>
                        <small>Website yang ingin dikunjungi (tanpa https://)</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="iterations">ğŸ”„ Jumlah Iterasi:</label>
                        <select id="iterations" name="iterations">
                            <option value="1">1</option>
                            <option value="3">3</option>
                            <option value="5">5</option>
                            <option value="10">10</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                    
                    <div class="button-group">
                        <button type="button" id="startBtn" onclick="startTraffic()">
                            ğŸš€ Mulai Traffic Generation
                        </button>
                        <button type="button" id="stopBtn" onclick="stopTraffic()" disabled>
                            â¹ï¸ Hentikan Process
                        </button>
                    </div>
                </form>
            </div>
        </div>
        
        <!-- Proxy Management Tab -->
        <div id="proxyTab" class="tab-content">
            <div class="proxy-management">
                <div class="form-group">
                    <label for="proxies">ğŸ“‹ Daftar Proxy (satu per baris):</label>
                    <textarea id="proxies" name="proxies" rows="8" 
                              placeholder="http://45.77.56.101:3128&#10;http://51.158.68.68:8811&#10;http://163.172.157.7:8080"></textarea>
                    <small>Format: http://ip:port atau https://ip:port</small>
                </div>
                
                <div class="button-group">
                    <button type="button" onclick="updateProxies()">
                        ğŸ’¾ Simpan Proxy List
                    </button>
                    <button type="button" onclick="checkProxies()">
                        ğŸ” Test Proxy Aktif
                    </button>
                    <button type="button" onclick="loadDefaultProxies()">
                        ğŸ“¥ Load Default Proxy
                    </button>
                </div>
                
                <div class="proxy-lists">
                    <div class="proxy-list">
                        <h4>âœ… Proxy Aktif (<span id="activeCount">0</span>):</h4>
                        <div id="activeProxies" class="proxy-list-container"></div>
                    </div>
                    
                    <div class="proxy-list">
                        <h4>ğŸ“‹ Semua Proxy (<span id="totalCount">0</span>):</h4>
                        <div id="allProxies" class="proxy-list-container"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Live View Tab -->
        <div id="liveViewTab" class="tab-content">
            <div class="live-view-container">
                <div class="live-status">
                    <h3>ğŸ“Š Real-time Status</h3>
                    <div class="status-cards">
                        <div class="status-card">
                            <div class="status-title">Status Utama</div>
                            <div id="mainStatus" class="status-value">Ready</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">Step Saat Ini</div>
                            <div id="currentStep" class="status-value">Menunggu proses dimulai...</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">Proxy Aktif</div>
                            <div id="currentProxy" class="status-value">-</div>
                        </div>
                        <div class="status-card">
                            <div class="status-title">Website Dibuka</div>
                            <div id="websiteStatus" class="status-value">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="progress-section">
                    <h3>ğŸ“ˆ Progress</h3>
                    <div class="progress-container">
                        <div class="progress-bar">
                            <div id="progressFill" class="progress-fill"></div>
                        </div>
                        <span id="progressText">0%</span>
                    </div>
                    <div id="iterationProgress" class="iteration-progress">Iterasi: 0/0</div>
                </div>
                
                <div class="screenshot-section">
                    <h3>ğŸ–¼ï¸ Live Screenshot</h3>
                    <div id="screenshotContainer" class="screenshot-container">
                        <div class="no-screenshot">
                            <p>ğŸ“· Screenshot akan muncul di sini saat proses berjalan</p>
                            <p><small>Browser akan menampilkan screenshot setiap step</small></p>
                        </div>
                        <img id="liveScreenshot" class="screenshot-image" style="display: none;">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let statusInterval;
        let currentTab = 'trafficTab';
        
        function openTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all buttons
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab
            document.getElementById(tabName).classList.add('active');
            
            // Activate clicked button
            event.currentTarget.classList.add('active');
            currentTab = tabName;
            
            if (tabName === 'proxyTab') {
                loadProxies();
            }
        }
        
        function startTraffic() {
            const formData = {
                keyword: document.getElementById('keyword').value,
                website_url: document.getElementById('website_url').value,
                iterations: parseInt(document.getElementById('iterations').value)
            };
            
            if (!formData.website_url) {
                alert('âš ï¸ Masukkan URL target website!');
                return;
            }
            
            if (!formData.keyword) {
                alert('âš ï¸ Masukkan kata kunci pencarian!');
                return;
            }
            
            // Switch to live view tab
            openTab('liveViewTab');
            
            fetch('/start_traffic', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('startBtn').disabled = true;
                document.getElementById('stopBtn').disabled = false;
                
                // Mulai polling status
                statusInterval = setInterval(updateStatus, 1500);
            })
            .catch(error => {
                console.error('Error:', error);
            });
        }
        
        function stopTraffic() {
            fetch('/stop_traffic', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                document.getElementById('startBtn').disabled = false;
                document.getElementById('stopBtn').disabled = true;
                clearInterval(statusInterval);
            });
        }
        
        function updateStatus() {
            fetch('/status')
            .then(response => response.json())
            .then(data => {
                // Update main status
                document.getElementById('mainStatus').textContent = data.status;
                document.getElementById('globalStatus').textContent = data.status;
                
                // Update current step
                document.getElementById('currentStep').textContent = data.current_step;
                
                // Update proxy info
                document.getElementById('currentProxy').textContent = data.proxy || '-';
                
                // Update website status
                document.getElementById('websiteStatus').textContent = data.website_opened ? 'âœ… Berhasil' : 'âŒ Gagal';
                document.getElementById('websiteStatus').className = 'status-value ' + 
                    (data.website_opened ? 'status-success' : 'status-error');
                
                // Update progress
                if (data.total_iterations > 0) {
                    const progress = (data.current_iteration / data.total_iterations) * 100;
                    document.getElementById('progressFill').style.width = progress + '%';
                    document.getElementById('progressText').textContent = Math.round(progress) + '%';
                    document.getElementById('iterationProgress').textContent = 
                        `Iterasi: ${data.current_iteration}/${data.total_iterations}`;
                    document.getElementById('iterationStatus').textContent = 
                        `${data.current_iteration}/${data.total_iterations}`;
                }
                
                // Update screenshot
                if (data.screenshot) {
                    const screenshotImg = document.getElementById('liveScreenshot');
                    screenshotImg.src = data.screenshot;
                    screenshotImg.style.display = 'block';
                    document.querySelector('.no-screenshot').style.display = 'none';
                }
                
                // Jika selesai, enable start button
                if (data.status.includes('selesai') || data.status.includes('Error') || data.status.includes('Dihentikan')) {
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('stopBtn').disabled = true;
                }
            })
            .catch(error => {
                console.error('Error fetching status:', error);
            });
        }
        
        function loadProxies() {
            fetch('/get_proxies')
            .then(response => response.json())
            .then(data => {
                document.getElementById('totalProxies').textContent = data.total_proxies;
                document.getElementById('workingProxies').textContent = data.working_proxies;
                document.getElementById('totalCount').textContent = data.total_proxies;
                document.getElementById('activeCount').textContent = data.working_proxies;
                
                // Display all proxies
                const allProxiesContainer = document.getElementById('allProxies');
                allProxiesContainer.innerHTML = data.proxy_list.map(proxy => 
                    `<div class="proxy-item">${proxy}</div>`
                ).join('');
                
                // Display working proxies
                const activeProxiesContainer = document.getElementById('activeProxies');
                activeProxiesContainer.innerHTML = data.working_list.map(proxy => 
                    `<div class="proxy-item active">âœ… ${proxy}</div>`
                ).join('');
            });
        }
        
        function updateProxies() {
            const proxiesText = document.getElementById('proxies').value;
            
            if (!proxiesText) {
                alert('âš ï¸ Masukkan daftar proxy!');
                return;
            }
            
            fetch('/update_proxies', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ proxies: proxiesText })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
                if (data.status === 'success') {
                    loadProxies();
                }
            });
        }
        
        function checkProxies() {
            alert('ğŸ” Memeriksa proxy yang aktif...');
            loadProxies();
        }
        
        function loadDefaultProxies() {
            const defaultProxies = `http://45.77.56.101:3128
http://51.158.68.68:8811
http://163.172.157.7:8080
http://51.158.68.133:8811
http://51.158.68.26:8811
http://37.187.116.199:8118
http://195.154.51.58:8118
http://217.182.120.164:8080`;
            
            document.getElementById('proxies').value = defaultProxies;
        }
        
        // Load proxies on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadProxies();
            updateStatus();
        });
    </script>
</body>
    </html>
